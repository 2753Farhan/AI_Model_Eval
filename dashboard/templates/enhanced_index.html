<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI ModelEval Dashboard</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <!-- Plotly -->
    <script src="https://cdn.plot.ly/plotly-2.24.1.min.js"></script>
    <!-- Custom CSS -->
    <link href="{{ url_for('static', filename='css/custom.css') }}" rel="stylesheet">
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container">
            <a class="navbar-brand" href="/">
                <i class="fas fa-robot"></i> AI ModelEval Dashboard
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link active" href="/">
                            <i class="fas fa-tachometer-alt"></i> Dashboard
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/model_comparison">
                            <i class="fas fa-chart-bar"></i> Model Comparison
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/evaluation_results">
                            <i class="fas fa-list"></i> Evaluation Results
                        </a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="container-fluid mt-4">
        <!-- Header -->
        <div class="row mb-4">
            <div class="col-12">
                <h1 class="display-4">
                    <i class="fas fa-tachometer-alt text-primary"></i> AI Model Evaluation Dashboard
                </h1>
                <p class="lead text-muted">
                    Compare AI code generation models on HumanEval benchmark
                </p>
            </div>
        </div>

        <!-- Summary Stats -->
        <div class="row mb-4">
            <div class="col-md-3 mb-3">
                <div class="card bg-primary text-white">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="card-title">Models Evaluated</h6>
                                <h2>{{ model_comparison|length if model_comparison else 0 }}</h2>
                            </div>
                            <i class="fas fa-robot fa-3x opacity-50"></i>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="col-md-3 mb-3">
                <div class="card bg-success text-white">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="card-title">Best Pass Rate</h6>
                                <h2>
                                    {% if model_comparison %}
                                        {{ (model_comparison|map(attribute='pass_rate')|max * 100)|round(1) }}%
                                    {% else %}
                                        0%
                                    {% endif %}
                                </h2>
                            </div>
                            <i class="fas fa-trophy fa-3x opacity-50"></i>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="col-md-3 mb-3">
                <div class="card bg-info text-white">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="card-title">Total Tests</h6>
                                <h2>
                                    {% if model_comparison %}
                                        {{ model_comparison|sum(attribute='total_tests') }}
                                    {% else %}
                                        0
                                    {% endif %}
                                </h2>
                            </div>
                            <i class="fas fa-vial fa-3x opacity-50"></i>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="col-md-3 mb-3">
                <div class="card bg-warning text-white">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="card-title">Avg Execution Time</h6>
                                <h2>
                                    {% if model_comparison and model_comparison[0].get('avg_execution_time') %}
                                        {{ model_comparison[0]['avg_execution_time']|round(2) }}s
                                    {% else %}
                                        0s
                                    {% endif %}
                                </h2>
                            </div>
                            <i class="fas fa-clock fa-3x opacity-50"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Model Comparison Table -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header bg-light">
                        <h5 class="card-title mb-0">
                            <i class="fas fa-table"></i> Model Performance Comparison
                            {% if has_evaluation_data %}
                                <span class="badge bg-success ms-2">Data Loaded</span>
                            {% else %}
                                <span class="badge bg-warning ms-2">No Data</span>
                            {% endif %}
                        </h5>
                    </div>
                    <div class="card-body">
                        {% if model_comparison %}
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead class="table-dark">
                                    <tr>
                                        <th>Model</th>
                                        <th>Pass Rate</th>
                                        <th>Pass@1</th>
                                        <th>Pass@5</th>
                                        <th>Total Tests</th>
                                        <th>Passed Tests</th>
                                        <th>Avg Time</th>
                                        <th>Rank</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for model in model_comparison|sort(attribute='pass_rate', reverse=true) %}
                                    <tr>
                                        <td>
                                            <strong>{{ model.model }}</strong>
                                            {% if loop.first %}
                                                <span class="badge bg-warning ms-2">Best</span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            <div class="progress" style="height: 20px;">
                                                <div class="progress-bar 
                                                    {% if model.pass_rate > 0.7 %}bg-success
                                                    {% elif model.pass_rate > 0.4 %}bg-warning
                                                    {% else %}bg-danger{% endif %}" 
                                                    style="width: {{ model.pass_rate * 100 }}%">
                                                    {{ (model.pass_rate * 100)|round(1) }}%
                                                </div>
                                            </div>
                                        </td>
                                        <td>{{ (model.get('pass@1', 0) * 100)|round(1) }}%</td>
                                        <td>{{ (model.get('pass@5', 0) * 100)|round(1) }}%</td>
                                        <td>{{ model.total_tests }}</td>
                                        <td>
                                            <span class="badge bg-success">{{ model.passed_tests }}</span>
                                        </td>
                                        <td>
                                            {% if model.get('avg_execution_time') %}
                                                {{ model.avg_execution_time|round(2) }}s
                                            {% else %}
                                                N/A
                                            {% endif %}
                                        </td>
                                        <td>
                                            <span class="badge bg-dark">#{{ loop.index }}</span>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        {% else %}
                        <div class="text-center py-5">
                            <i class="fas fa-robot fa-4x text-muted mb-3"></i>
                            <h4>No Evaluation Data Available</h4>
                            <p class="text-muted">Run the AI model evaluation first to generate comparison data.</p>
                            <a href="#" class="btn btn-primary">
                                <i class="fas fa-play"></i> Run Evaluation
                            </a>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        <!-- Charts Section -->
        {% if has_evaluation_data %}
        <div class="row">
            <div class="col-lg-6 mb-4">
                <div class="card h-100">
                    <div class="card-header">
                        <h5 class="card-title mb-0">
                            <i class="fas fa-chart-bar"></i> Model Pass Rates Comparison
                        </h5>
                    </div>
                    <div class="card-body">
                        <div id="passRateChart" style="height: 300px;">
                            <div class="text-center text-muted py-4">
                                <i class="fas fa-spinner fa-spin me-2"></i> Loading chart...
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="col-lg-6 mb-4">
                <div class="card h-100">
                    <div class="card-header">
                        <h5 class="card-title mb-0">
                            <i class="fas fa-chart-line"></i> Pass@1 vs Pass@5
                        </h5>
                    </div>
                    <div class="card-body">
                        <div id="passAtKChart" style="height: 300px;">
                            <div class="text-center text-muted py-4">
                                <i class="fas fa-spinner fa-spin me-2"></i> Loading chart...
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}

        <!-- Quick Actions -->
        <div class="row mt-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5 class="card-title mb-0">
                            <i class="fas fa-bolt"></i> Quick Actions
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-3 mb-3">
                                <a href="/model_comparison" class="btn btn-primary w-100">
                                    <i class="fas fa-chart-bar me-2"></i> Detailed Comparison
                                </a>
                            </div>
                            <div class="col-md-3 mb-3">
                                <a href="/evaluation_results" class="btn btn-info w-100">
                                    <i class="fas fa-list me-2"></i> View All Results
                                </a>
                            </div>
                            <div class="col-md-3 mb-3">
                                <button onclick="refreshData()" class="btn btn-warning w-100">
                                    <i class="fas fa-sync-alt me-2"></i> Refresh Data
                                </button>
                            </div>
                            <div class="col-md-3 mb-3">
                                <button onclick="exportData()" class="btn btn-success w-100">
                                    <i class="fas fa-download me-2"></i> Export Results
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Status Information -->
        <div class="row mt-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5 class="card-title mb-0">
                            <i class="fas fa-info-circle"></i> System Status
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <h6>Data Status:</h6>
                                <ul class="list-unstyled">
                                    <li>
                                        <i class="fas fa-check-circle text-success me-2"></i>
                                        Models Loaded: <strong>{{ model_comparison|length if model_comparison else 0 }}</strong>
                                    </li>
                                    <li>
                                        <i class="fas fa-check-circle text-success me-2"></i>
                                        Evaluation Complete: <strong>{{ "Yes" if has_evaluation_data else "No" }}</strong>
                                    </li>
                                    <li>
                                        <i class="fas fa-check-circle text-success me-2"></i>
                                        Dashboard Active: <strong>Yes</strong>
                                    </li>
                                </ul>
                            </div>
                            <div class="col-md-6">
                                <h6>Last Updated:</h6>
                                <p class="text-muted">
                                    <i class="fas fa-clock me-2"></i>
                                    <span id="currentTime">Loading...</span>
                                </p>
                                <h6>Next Steps:</h6>
                                <ul>
                                    <li>View detailed model comparisons</li>
                                    <li>Analyze individual evaluation results</li>
                                    <li>Export data for further analysis</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="bg-dark text-light mt-5 py-4">
        <div class="container text-center">
            <p class="mb-0">AI ModelEval Dashboard - Evaluating Code Generation Models</p>
            <small>Built with Flask, Plotly, and Bootstrap</small>
        </div>
    </footer>

    <!-- JavaScript -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Update current time
        function updateTime() {
            const now = new Date();
            const timeString = now.toLocaleDateString() + ' ' + now.toLocaleTimeString();
            document.getElementById('currentTime').textContent = timeString;
        }
        
        // Initial time update
        updateTime();
        // Update time every second
        setInterval(updateTime, 1000);

        {% if has_evaluation_data %}
        // Load charts when page is ready
        document.addEventListener('DOMContentLoaded', function() {
            loadCharts();
        });

        function loadCharts() {
            // Fetch chart data from API
            fetch('/api/model_metrics')
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        console.error('Error loading chart data:', data.error);
                        showChartError();
                        return;
                    }

                    // Create Pass Rate Chart
                    const passRateTrace = {
                        x: data.pass_rates.x,
                        y: data.pass_rates.y,
                        type: 'bar',
                        name: 'Pass Rate',
                        marker: {
                            color: data.pass_rates.y.map(rate => 
                                rate > 0.7 ? '#27ae60' : 
                                rate > 0.4 ? '#f39c12' : '#e74c3c'
                            )
                        }
                    };

                    const passRateLayout = {
                        title: 'Model Pass Rates',
                        xaxis: { title: 'Model' },
                        yaxis: { 
                            title: 'Pass Rate', 
                            tickformat: ',.0%',
                            range: [0, 1]
                        },
                        height: 300
                    };

                    Plotly.newPlot('passRateChart', [passRateTrace], passRateLayout);

                    // Create Pass@1 vs Pass@5 Chart
                    const passAt1Trace = {
                        x: data.pass_at_1.x,
                        y: data.pass_at_1.y,
                        type: 'bar',
                        name: 'Pass@1',
                        marker: { color: '#3498db' }
                    };

                    const passAt5Trace = {
                        x: data.pass_at_1.x,
                        y: data.pass_rates.y, // Using pass rates as proxy for Pass@5
                        type: 'bar',
                        name: 'Pass Rate',
                        marker: { color: '#9b59b6' }
                    };

                    const passAtKLayout = {
                        title: 'Pass@1 vs Overall Pass Rate',
                        xaxis: { title: 'Model' },
                        yaxis: { 
                            title: 'Rate', 
                            tickformat: ',.0%',
                            range: [0, 1]
                        },
                        barmode: 'group',
                        height: 300
                    };

                    Plotly.newPlot('passAtKChart', [passAt1Trace, passAt5Trace], passAtKLayout);
                })
                .catch(error => {
                    console.error('Error loading charts:', error);
                    showChartError();
                });
        }

        function showChartError() {
            document.getElementById('passRateChart').innerHTML = 
                '<div class="text-center text-muted py-4">Failed to load charts</div>';
            document.getElementById('passAtKChart').innerHTML = 
                '<div class="text-center text-muted py-4">Failed to load charts</div>';
        }
        {% endif %}

        function refreshData() {
            location.reload();
        }

        function exportData() {
            alert('Export functionality would download all evaluation data as CSV');
            // In a real implementation, this would trigger a file download
        }
    </script>
</body>
</html>