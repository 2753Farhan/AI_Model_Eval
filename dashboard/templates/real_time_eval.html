<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Real-time AI Model Evaluation</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/custom.css') }}">
    <script src="https://cdn.plot.ly/plotly-2.24.1.min.js"></script>
    <style>
        .status-card {
            transition: all 0.3s ease;
            border-left: 5px solid #3498db;
        }
        .status-card.running {
            border-left-color: #f39c12;
            background-color: #fff8e1;
        }
        .status-card.success {
            border-left-color: #27ae60;
            background-color: #e8f5e9;
        }
        .status-card.error {
            border-left-color: #e74c3c;
            background-color: #ffebee;
        }
        .log-entry {
            padding: 8px 12px;
            margin: 2px 0;
            border-radius: 4px;
            font-family: 'Monaco', 'Consolas', monospace;
            font-size: 0.9em;
        }
        .log-info { background-color: #e3f2fd; color: #1565c0; }
        .log-success { background-color: #e8f5e9; color: #2e7d32; }
        .log-warning { background-color: #fff3e0; color: #ef6c00; }
        .log-error { background-color: #ffebee; color: #c62828; }
        .progress-stage {
            padding: 10px;
            margin: 5px 0;
            border-radius: 5px;
            background: #f8f9fa;
            transition: all 0.3s;
        }
        .progress-stage.active {
            background: #3498db;
            color: white;
        }
        .progress-stage.completed {
            background: #27ae60;
            color: white;
        }
        #logContainer {
            height: 400px;
            overflow-y: auto;
            background: #1e1e1e;
            color: #d4d4d4;
            font-family: 'Monaco', 'Consolas', monospace;
            border-radius: 5px;
            padding: 10px;
        }
        .metric-badge {
            font-size: 0.8em;
            padding: 3px 8px;
            margin: 0 2px;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container">
            <a class="navbar-brand" href="#">
                <i class="fas fa-bolt"></i> Real-time AI Model Evaluation
            </a>
        </div>
    </nav>

    <div class="container-fluid mt-4">
        <!-- Control Panel -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5 class="card-title mb-0">
                            <i class="fas fa-play-circle"></i> Evaluation Control Panel
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Models to Evaluate:</label>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="model1" value="codellama:7b" checked>
                                        <label class="form-check-label" for="model1">
                                            <code>codellama:7b</code> - CodeLlama 7B
                                        </label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="model2" value="starcoder:1b">
                                        <label class="form-check-label" for="model2">
                                            <code>starcoder:1b</code> - StarCoder 1B
                                        </label>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Samples per Task:</label>
                                    <input type="number" id="numSamples" class="form-control" value="2" min="1" max="10">
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Test Configuration:</label>
                                    <select id="testConfig" class="form-select">
                                        <option value="quick">Quick Test (3 problems)</option>
                                        <option value="standard">Standard (10 problems)</option>
                                        <option value="full">Full Evaluation</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                            <button id="startBtn" class="btn btn-primary" onclick="startEvaluation()">
                                <i class="fas fa-play"></i> Start Evaluation
                            </button>
                            <button id="stopBtn" class="btn btn-danger" onclick="stopEvaluation()" disabled>
                                <i class="fas fa-stop"></i> Stop
                            </button>
                            <button id="refreshBtn" class="btn btn-info" onclick="loadResults()">
                                <i class="fas fa-sync-alt"></i> Refresh Results
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Progress Visualization -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5 class="card-title mb-0">
                            <i class="fas fa-tachometer-alt"></i> Real-time Progress
                        </h5>
                    </div>
                    <div class="card-body">
                        <!-- Progress Stages -->
                        <div class="row mb-4">
                            <div class="col-md-3">
                                <div id="stage1" class="progress-stage text-center">
                                    <i class="fas fa-database fa-2x mb-2"></i><br>
                                    <strong>Loading Data</strong>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div id="stage2" class="progress-stage text-center">
                                    <i class="fas fa-robot fa-2x mb-2"></i><br>
                                    <strong>Checking Models</strong>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div id="stage3" class="progress-stage text-center">
                                    <i class="fas fa-code fa-2x mb-2"></i><br>
                                    <strong>Generating Code</strong>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div id="stage4" class="progress-stage text-center">
                                    <i class="fas fa-vial fa-2x mb-2"></i><br>
                                    <strong>Executing Tests</strong>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Progress Bars -->
                        <div class="mb-3">
                            <label>Overall Progress:</label>
                            <div class="progress" style="height: 25px;">
                                <div id="overallProgress" class="progress-bar progress-bar-striped progress-bar-animated" 
                                     role="progressbar" style="width: 0%">0%</div>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-4">
                                <div class="card">
                                    <div class="card-body text-center">
                                        <h6>Solutions Generated</h6>
                                        <h2 id="solutionsCount">0</h2>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="card">
                                    <div class="card-body text-center">
                                        <h6>Tests Executed</h6>
                                        <h2 id="testsCount">0</h2>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="card">
                                    <div class="card-body text-center">
                                        <h6>Success Rate</h6>
                                        <h2 id="successRate">0%</h2>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Live Logs -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5 class="card-title mb-0">
                            <i class="fas fa-terminal"></i> Live Execution Logs
                        </h5>
                    </div>
                    <div class="card-body p-0">
                        <div id="logContainer">
                            <div class="log-entry log-info">Waiting for evaluation to start...</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Real-time Charts -->
        <div class="row mb-4">
            <div class="col-lg-6">
                <div class="card h-100">
                    <div class="card-header">
                        <h5 class="card-title mb-0">
                            <i class="fas fa-chart-line"></i> Success Rate Over Time
                        </h5>
                    </div>
                    <div class="card-body">
                        <div id="successChart" style="height: 300px;"></div>
                    </div>
                </div>
            </div>
            <div class="col-lg-6">
                <div class="card h-100">
                    <div class="card-header">
                        <h5 class="card-title mb-0">
                            <i class="fas fa-chart-bar"></i> Model Performance
                        </h5>
                    </div>
                    <div class="card-body">
                        <div id="modelChart" style="height: 300px;"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Results Section -->
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5 class="card-title mb-0">
                            <i class="fas fa-table"></i> Latest Results
                        </h5>
                    </div>
                    <div class="card-body">
                        <div id="resultsTable">
                            <div class="text-center text-muted py-4">
                                <i class="fas fa-spinner fa-spin"></i> Loading results...
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let eventSource = null;
        let isRunning = false;
        let progressData = {
            steps: {},
            metrics: {}
        };

        // Initialize charts
        let successChart = null;
        let modelChart = null;
        
        document.addEventListener('DOMContentLoaded', function() {
            initializeCharts();
            loadResults();
        });

        function initializeCharts() {
            // Success rate chart
            successChart = Plotly.newPlot('successChart', [{
                x: [],
                y: [],
                type: 'scatter',
                mode: 'lines+markers',
                name: 'Success Rate',
                line: { color: '#27ae60', width: 3 }
            }], {
                title: 'Success Rate Over Time',
                xaxis: { title: 'Time' },
                yaxis: { title: 'Success Rate (%)', range: [0, 100] },
                showlegend: true
            });

            // Model performance chart
            modelChart = Plotly.newPlot('modelChart', [{
                x: [],
                y: [],
                type: 'bar',
                name: 'Pass Rate',
                marker: { color: '#3498db' }
            }], {
                title: 'Model Performance',
                xaxis: { title: 'Model' },
                yaxis: { title: 'Pass Rate (%)', range: [0, 100] }
            });
        }

        function startEvaluation() {
            if (isRunning) return;

            // Get configuration
            const models = Array.from(document.querySelectorAll('input[type="checkbox"]:checked'))
                .map(cb => cb.value);

            // FIXED: Changed 'num_samples' to 'numSamples' (matching the HTML element ID)
            const numSamples = parseInt(document.getElementById('numSamples').value);

            if (models.length === 0) {
                alert('Please select at least one model');
                return;
            }
        
            // Reset UI
            resetProgress();
            clearLogs();
            document.getElementById('startBtn').disabled = true;
            document.getElementById('stopBtn').disabled = false;
            isRunning = true;
        
            // Build URL with query parameters
            const params = new URLSearchParams({
                models: models.join(','),
                num_samples: numSamples  // FIXED: Using correct variable name
            });

            const url = `/api/start_evaluation?${params}`;
            console.log(`Connecting to SSE: ${url}`);

            // Start EventSource
            eventSource = new EventSource(url);

            eventSource.onopen = function(e) {
                console.log('SSE connection opened');
                addLog('Connected to evaluation server', 'success');
            };

            eventSource.onmessage = function(e) {
                console.log('SSE raw message:', e.data);
                try {
                    const data = JSON.parse(e.data);
                    handleEvent(data.type || 'message', data);
                } catch (error) {
                    console.error('Failed to parse event data:', error);
                    // Try to handle as direct message
                    if (e.data) {
                        addLog(`Message: ${e.data}`, 'info');
                    }
                }
            };

            eventSource.addEventListener('status', function(e) {
                try {
                    const data = JSON.parse(e.data);
                    handleEvent('status', data);
                } catch (error) {
                    console.error('Failed to parse status event:', error);
                }
            });

            eventSource.addEventListener('progress', function(e) {
                try {
                    const data = JSON.parse(e.data);
                    handleEvent('progress', data);
                } catch (error) {
                    console.error('Failed to parse progress event:', error);
                }
            });

            eventSource.addEventListener('complete', function(e) {
                try {
                    const data = JSON.parse(e.data);
                    handleEvent('complete', data);
                } catch (error) {
                    console.error('Failed to parse complete event:', error);
                }
            });

            eventSource.addEventListener('error', function(e) {
                try {
                    const data = JSON.parse(e.data);
                    handleEvent('error', data);
                } catch (error) {
                    console.error('Failed to parse error event:', error);
                    addLog('SSE stream error', 'error');
                }
            });

            eventSource.onerror = function(error) {
                console.error('EventSource connection error:', error);
                addLog('Connection lost or error occurred', 'error');
                if (eventSource.readyState === EventSource.CLOSED) {
                    stopEvaluation();
                }
            };
        }

        // Also fix the testSSE function if you want to use it:
        function testSSE() {
            console.log('Testing SSE connection...');
            const testEventSource = new EventSource('/api/test_sse');

            testEventSource.onopen = function() {
                console.log('Test SSE connected');
                addLog('Test SSE connected', 'success');
            };

            testEventSource.onmessage = function(e) {
                console.log('Test SSE message:', e.data);
                addLog(`Test: ${e.data}`, 'info');
            };

            testEventSource.onerror = function(e) {
                console.log('Test SSE error:', e);
                addLog('Test SSE failed', 'error');
                testEventSource.close();
            };

            setTimeout(() => {
                testEventSource.close();
                console.log('Test SSE closed');
            }, 6000);
        }        
        // Add test function to debug SSE

        function stopEvaluation() {
            if (eventSource) {
                eventSource.close();
                eventSource = null;
            }
            
            document.getElementById('startBtn').disabled = false;
            document.getElementById('stopBtn').disabled = true;
            isRunning = false;
            
            addLog('Evaluation stopped by user', 'warning');
        }

        function handleEvent(type, data) {
            switch(type) {
                case 'progress':
                    updateProgress(data.step, data.message, data.data);
                    break;
                case 'status':
                    updateStatus(data.status, data.message);
                    break;
                case 'complete':
                    handleCompletion(data);
                    break;
                case 'error':
                    handleError(data.message);
                    break;
            }
        }

        function updateProgress(step, message, data) {
            // Update progress stages
            document.querySelectorAll('.progress-stage').forEach(stage => {
                stage.classList.remove('active', 'completed');
            });
            
            const stageMap = {
                'loading_data': 'stage1',
                'checking_models': 'stage2', 
                'generating_code': 'stage3',
                'executing_tests': 'stage4',
                'calculating_metrics': 'stage4'
            };
            
            if (stageMap[step]) {
                const stage = document.getElementById(stageMap[step]);
                if (stage) {
                    stage.classList.add('active');
                }
            }
            
            // Update logs
            addLog(message, 'info');
            
            // Update metrics if provided
            if (data) {
                if (data.solutions_generated) {
                    document.getElementById('solutionsCount').textContent = data.solutions_generated;
                }
                if (data.tests_executed) {
                    document.getElementById('testsCount').textContent = data.tests_executed;
                }
                if (data.tests_passed) {
                    const total = data.tests_executed || 1;
                    const rate = Math.round((data.tests_passed / total) * 100);
                    document.getElementById('successRate').textContent = rate + '%';
                    
                    // Update chart
                    Plotly.extendTraces('successChart', {
                        x: [[new Date().toLocaleTimeString()]],
                        y: [[rate]]
                    }, [0]);
                }
            }
        }

        function updateStatus(status, message) {
            const statusCard = document.querySelector('.status-card');
            if (statusCard) {
                statusCard.className = 'card status-card ' + status;
            }
            
            addLog(message, status === 'error' ? 'error' : 'info');
        }

        function handleCompletion(data) {
            addLog('Evaluation completed successfully!', 'success');
            
            // Mark all stages as completed
            document.querySelectorAll('.progress-stage').forEach(stage => {
                stage.classList.remove('active');
                stage.classList.add('completed');
            });
            
            // Update overall progress
            document.getElementById('overallProgress').style.width = '100%';
            document.getElementById('overallProgress').textContent = '100%';
            
            // Load final results
            loadResults();
            
            // Stop SSE
            stopEvaluation();
        }

        function handleError(message) {
            addLog('Error: ' + message, 'error');
            stopEvaluation();
        }

        function addLog(message, type = 'info') {
            const container = document.getElementById('logContainer');
            const entry = document.createElement('div');
            entry.className = `log-entry log-${type}`;
            
            const timestamp = new Date().toLocaleTimeString();
            entry.textContent = `[${timestamp}] ${message}`;
            
            container.appendChild(entry);
            container.scrollTop = container.scrollHeight;
        }

        function clearLogs() {
            const container = document.getElementById('logContainer');
            container.innerHTML = '';
        }

        function resetProgress() {
            // Reset progress bars
            document.getElementById('overallProgress').style.width = '0%';
            document.getElementById('overallProgress').textContent = '0%';
            
            // Reset counters
            document.getElementById('solutionsCount').textContent = '0';
            document.getElementById('testsCount').textContent = '0';
            document.getElementById('successRate').textContent = '0%';
            
            // Reset stages
            document.querySelectorAll('.progress-stage').forEach(stage => {
                stage.classList.remove('active', 'completed');
            });
        }

        function loadResults() {
            fetch('/api/get_results')
                .then(response => response.json())
                .then(data => {
                    updateResultsTable(data);
                    updateCharts(data);
                })
                .catch(error => {
                    console.error('Failed to load results:', error);
                });
        }

        function updateResultsTable(data) {
            const container = document.getElementById('resultsTable');
            
            if (!data.summary) {
                container.innerHTML = '<div class="text-center text-muted py-4">No results available yet</div>';
                return;
            }
            
            let html = `
                <div class="row mb-3">
                    <div class="col-md-4">
                        <div class="card bg-light">
                            <div class="card-body text-center">
                                <h6>Total Solutions</h6>
                                <h2>${data.summary.total}</h2>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card bg-light">
                            <div class="card-body text-center">
                                <h6>Passed Solutions</h6>
                                <h2 class="text-success">${data.summary.passed}</h2>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card bg-light">
                            <div class="card-body text-center">
                                <h6>Overall Pass Rate</h6>
                                <h2>${data.summary.pass_rate.toFixed(1)}%</h2>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            if (data.model_stats) {
                html += '<h6>Model Performance:</h6><div class="table-responsive"><table class="table table-hover"><thead><tr><th>Model</th><th>Total Tests</th><th>Passed</th><th>Pass Rate</th></tr></thead><tbody>';
                
                for (const [model, stats] of Object.entries(data.model_stats)) {
                    html += `
                        <tr>
                            <td><code>${model}</code></td>
                            <td>${stats.count}</td>
                            <td>${stats.sum}</td>
                            <td>
                                <div class="progress" style="height: 20px;">
                                    <div class="progress-bar" style="width: ${stats.pass_rate}%">
                                        ${stats.pass_rate}%
                                    </div>
                                </div>
                            </td>
                        </tr>
                    `;
                }
                
                html += '</tbody></table></div>';
            }
            
            container.innerHTML = html;
        }

        function updateCharts(data) {
            if (data.model_stats) {
                const models = Object.keys(data.model_stats);
                const passRates = models.map(model => data.model_stats[model].pass_rate);
                
                Plotly.update('modelChart', {
                    x: [models],
                    y: [passRates]
                }, {
                    title: 'Model Performance'
                });
            }
        }
    </script>
</body>
</html>